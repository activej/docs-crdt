<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176574648-1"></script>
    <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-176574648-1');
    </script>
    
    <link rel='stylesheet' href='/static/css/pygment_trac.css'/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <title>ActiveJ CRDT Examples</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" Fast and efficient Java CRDT (conflict-free replicated data type) implementation. ">
    <meta name="keywords" content=" crdt,conflict-free replicated data type,java,scalable storage,eventually consistent,collaborative editing,key-value-storage ">
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <meta name="og:description" content="ActiveJ is an alternative Java platform built from the ground up as a replacement of Spring, Spark, Quarkus, Micronauts, and other solutions. It is minimalistic, boilerplate-free, and provides outstanding performance." />
    <meta name="og:image" content="https://activej.io/static/images/AJ_Card.jpeg" />
    <meta name="og:title" content="ActiveJ - An Alternative Java platform built for web, high load, and cloud development" />
</head>
<body>
    <div class="navbar-container-wrapper">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
            <ul class="navbar-nav-visible mr-auto mt-1 mt-lg-0">
                <div class="logo-link-title mr-5">
                    <img src="/favicon.png" style="max-width: 25px">
                    
                    
                    
                    
                    
                    
                    <a class="navbar-nav__link logo-link-title" href="/" style="margin-left: 5px">ActiveJ CRDT</a>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
            </ul>
            <button class="navbar-toggler m-1 ml-auto" type="button" data-toggle="collapse" data-target="#navbarToggler"
                    aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarToggler">
                <div class="container">
                    
                    
                    
                    
                    
                    
                    <ul class="navbar-nav navbar-nav-visible mr-auto mt-1 mt-lg-0">
                        
                        <li>
                            <a class="navbar-nav__link nav-expanded" href="/examples.html">
                                Examples
                            </a>
                        </li>
                        
                    </ul>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
                <span>
              <ul class="navbar-nav expanded-links navbar-nav-visible mr-auto mt-1 mt-lg-0">
                  <li class="dropdown">
                    <a class="nav-link nav-expanded">Components</a>
                    <ul class="dropdown__content">
                        
                            <div class="dropdown__content-wrapper">
                                
                                    <a href="https://activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://activej.io">ActiveJ</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Redefining Java for modern web applications </p>
                                    </a>
                                
                                    <a href="https://inject.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://inject.activej.io">ActiveJ Inject</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast and ultimately powerful DI library </p>
                                    </a>
                                
                                    <a href="https://serializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://serializer.activej.io">ActiveJ Serializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> The fastest JVM serializer in the world </p>
                                    </a>
                                
                                    <a href="https://codegen.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://codegen.activej.io">ActiveJ Codegen</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Dynamic bytecode generation without overhead of reflection </p>
                                    </a>
                                
                                    <a href="https://specializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://specializer.activej.io">ActiveJ Specializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> A little bit of magic to speed up your code </p>
                                    </a>
                                
                                    <a href="https://rpc.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://rpc.activej.io">ActiveJ RPC</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast binary protocol for microservices architecture </p>
                                    </a>
                                
                                    <a href="https://fs.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://fs.activej.io">ActiveJ FS</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Tiny abstraction for managing local, remote, and distributed FS </p>
                                    </a>
                                
                           </div>
                        
                    </ul>
                </li>
                  <li><a class="navbar-nav__link" href="https://activej.io/blog/release-notes.html">Blog</a> </li>
                <li><a class="navbar-nav__link" href="http://uikernel.io">UIKernel</a></li>
                <li><a class="navbar-nav__link" href="https://adkernel.com">AdKernel</a></li>
                <li><a class="navbar-nav__link" href="https://github.com/activej/activej">GitHub</a></li>
                <li><a class="navbar-nav__link" href="/about.html">About us</a></li>
              </ul>
            </span>
            </div>
        </nav>
    </div>
</div>

    <div class="content">
        
            <div class="container">
                <div class="row">
                    <div class="px-0 mb-3 sidebar">
    
<h3>Examples</h3>
<ul>
    
    <li>
        <a href="/examples.html#simple-crdt">Simple CRDT</a>
    </li>
    
    <li>
        <a href="/examples.html#crdt-clusters">CRDT Clusterization</a>
    </li>
    
    <li>
        <a href="/examples.html#crdt-consolidation">CRDT Consolidation</a>
    </li>
    
</ul>

</div>
<div class="pr-3 markdown-content docs-content">
    <div class="status-wrapper">
        <h1> </h1>
    </div>
    <div class="note-wrapper">
    <div class="note">
        <b>Note:</b>
        To run the examples, you need to clone ActiveJ project from GitHub: 
<br /> <b>$ git clone https://github.com/activej/activej</b> 
<br /> And import it as a Maven project. Check out tag <b>v4.3</b>. Before running the examples, build the project.
<br /> These examples are located at <b>activej -&gt; examples -&gt; cloud -&gt; crdt</b>.
    </div>
</div>

<p>These examples utilize other ActiveJ technologies, particularly <a href="https://activej.io">ActiveJ platform</a> and <a href="https://serializer.activej.io">ActiveJ Serializer</a></p>

<h3 id="simple-crdt">Simple CRDT</h3>
<p>This example illustrates some basic CRDT functionality. We will create a ‘remote’ CRDT storage that contains some 
key-value pairs. There is also a <a href="https://github.com/activej/activej/blob/v4.3/extra/cloud-crdt/src/main/java/io/activej/crdt/CrdtServer.java">CrdtServer</a> for this storage.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// create the 'remote' storage</span>
<span class="nc">CrdtStorageMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">remoteStorage</span> <span class="o">=</span> <span class="nc">CrdtStorageMap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="no">CRDT_FUNCTION</span><span class="o">);</span>

<span class="c1">// put some default data into that storage</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mx"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"only_remote"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">35</span><span class="o">));</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"only_remote"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>

<span class="c1">// and also output it for later comparison</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Data at 'remote' storage:"</span><span class="o">);</span>
<span class="n">remoteStorage</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">forEachRemaining</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

<span class="c1">// create and run a server for the 'remote' storage</span>
<span class="nc">CrdtServer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">CrdtServer</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">remoteStorage</span><span class="o">,</span> <span class="no">INTEGER_SERIALIZER</span><span class="o">)</span>
		<span class="o">.</span><span class="na">withListenAddress</span><span class="o">(</span><span class="no">ADDRESS</span><span class="o">);</span>
<span class="n">server</span><span class="o">.</span><span class="na">listen</span><span class="o">();</span></code></pre></figure>

<p>In order to resolve possible conflicts when adding new data to the remote storage, we define a <a href="https://github.com/activej/activej/blob/v4.3/extra/cloud-crdt/src/main/java/io/activej/crdt/function/CrdtFunction.java">CrdtFunction</a>.
If there are any conflicting keys, <em>crdtFunction</em> compares their corresponding values and returns a bigger one. It will put to the storage.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">CrdtFunction</span><span class="o">&lt;</span><span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="no">CRDT_FUNCTION</span> <span class="o">=</span>
		<span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">createCrdtFunction</span><span class="o">(</span><span class="nl">Integer:</span><span class="o">:</span><span class="n">max</span><span class="o">);</span></code></pre></figure>

<p>We also need to define a CRDT client which is a <a href="https://github.com/activej/activej/blob/v4.3/extra/cloud-crdt/src/main/java/io/activej/crdt/CrdtStorageClient.java">CrdtStorageClient</a>.
And a local storage similarly to the remote storage.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// now crate the client for that 'remote' storage</span>
<span class="nc">CrdtStorage</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">client</span> <span class="o">=</span>
		<span class="nc">CrdtStorageClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="no">ADDRESS</span><span class="o">,</span> <span class="no">INTEGER_SERIALIZER</span><span class="o">);</span>

<span class="c1">// and also create the local storage</span>
<span class="nc">CrdtStorageMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">localStorage</span> <span class="o">=</span>
		<span class="nc">CrdtStorageMap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="no">CRDT_FUNCTION</span><span class="o">);</span>

<span class="c1">// and fill it with some other values</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mx"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">22</span><span class="o">));</span>
<span class="c1">// conflicting keys will be resolved with the crdt function</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mx"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
<span class="c1">// so the actual value will be the max of all values of that key</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mx"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">23</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"only_local"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">47</span><span class="o">));</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"only_local"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>

<span class="c1">// and output it too for later comparison</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Data at the local storage:"</span><span class="o">);</span>
<span class="n">localStorage</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">forEachRemaining</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span></code></pre></figure>

<p>Now we can test uploading files to the remote storage from our client and then downloading it back. There will be some 
conflicting keys, so the conflicts will be resolved according to the provided CRDT function.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// now stream the local storage into the remote one through the TCP client-server pair</span>
<span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">localStorage</span><span class="o">.</span><span class="na">download</span><span class="o">())</span>
		<span class="o">.</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">upload</span><span class="o">()))</span>
		<span class="o">.</span><span class="na">whenComplete</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>

			<span class="c1">// check what is now at the 'remote' storage, the output should differ</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Synced data at 'remote' storage:"</span><span class="o">);</span>
			<span class="n">remoteStorage</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">forEachRemaining</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

			<span class="c1">// and now do the reverse process</span>
			<span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">download</span><span class="o">())</span>
					<span class="o">.</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">localStorage</span><span class="o">.</span><span class="na">upload</span><span class="o">()))</span>
					<span class="o">.</span><span class="na">whenComplete</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="c1">// now output the local storage, should be identical to the remote one</span>
						<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Synced data at the local storage:"</span><span class="o">);</span>
						<span class="n">localStorage</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">forEachRemaining</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
						<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

						<span class="c1">// also stop the server to let the program finish</span>
						<span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
					<span class="o">});</span>
		<span class="o">});</span>

<span class="n">eventloop</span><span class="o">.</span><span class="na">run</span><span class="o">();</span></code></pre></figure>

<h3 id="crdt-clusters">CRDT clusters</h3>
<p>One of the core CRDT features is clusterization. It allows clients to upload and download data to/from several servers.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// we create a list of 10 local partitions with string partition ids and string keys</span>
<span class="c1">// normally all of them would be network clients for remote partitions</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">CrdtStorage</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">clients</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
	<span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="s">"partition"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
	<span class="nc">Path</span> <span class="n">storage</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">createTempDirectory</span><span class="o">(</span><span class="s">"storage_"</span><span class="o">+</span> <span class="n">id</span><span class="o">);</span>
	<span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="nc">LocalActiveFs</span><span class="o">.</span><span class="na">DEFAULT_TEMP_DIR</span><span class="o">));</span>
	<span class="nc">ActiveFs</span> <span class="n">fs</span> <span class="o">=</span> <span class="nc">LocalActiveFs</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">storage</span><span class="o">);</span>
	<span class="n">clients</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nc">CrdtStorageFs</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">fs</span><span class="o">,</span> <span class="no">SERIALIZER</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// grab a couple of them to work with</span>
<span class="nc">CrdtStorage</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">partition3</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"partition3"</span><span class="o">);</span>
<span class="nc">CrdtStorage</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">partition6</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"partition6"</span><span class="o">);</span>

<span class="c1">// create a cluster with string keys, string partition ids,</span>
<span class="c1">// and with replication count of 5 meaning that uploading items to the</span>
<span class="c1">// cluster will make 5 copies of them across known partitions</span>
<span class="nc">CrdtStorageCluster</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">cluster</span> <span class="o">=</span> <span class="nc">CrdtStorageCluster</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">clients</span><span class="o">)</span>
		<span class="o">.</span><span class="na">withReplicationCount</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// sets on partition3</span>
<span class="nc">CrdtData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">firstOn3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"first"</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"#1"</span><span class="o">,</span> <span class="s">"#2"</span><span class="o">,</span> <span class="s">"#3"</span><span class="o">,</span> <span class="s">"#4"</span><span class="o">));</span>
<span class="nc">CrdtData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">secondOn3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"second"</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"#3"</span><span class="o">,</span> <span class="s">"#4"</span><span class="o">,</span> <span class="s">"#5"</span><span class="o">,</span> <span class="s">"#6"</span><span class="o">));</span>

<span class="c1">// sets on partition6</span>
<span class="nc">CrdtData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">firstOn6</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"first"</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"#3"</span><span class="o">,</span> <span class="s">"#4"</span><span class="o">,</span> <span class="s">"#5"</span><span class="o">,</span> <span class="s">"#6"</span><span class="o">));</span>

<span class="c1">// current implementation of LWWSet depends on system time</span>
<span class="c1">// so to make the below removes with a higher timestamp, we wait for just a bit</span>
<span class="k">try</span> <span class="o">{</span>
	<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="nc">LWWSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"#2"</span><span class="o">,</span> <span class="s">"#4"</span><span class="o">);</span>
<span class="n">set</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"#5"</span><span class="o">);</span>
<span class="n">set</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"#6"</span><span class="o">);</span>
<span class="nc">CrdtData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LWWSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">secondOn6</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"second"</span><span class="o">,</span> <span class="n">set</span><span class="o">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// then upload these sets to both partition3 and partition6</span>
<span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">uploadTo3</span> <span class="o">=</span> <span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">firstOn3</span><span class="o">,</span> <span class="n">secondOn3</span><span class="o">).</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">partition3</span><span class="o">.</span><span class="na">upload</span><span class="o">()));</span>
<span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">uploadTo6</span> <span class="o">=</span> <span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">firstOn6</span><span class="o">,</span> <span class="n">secondOn6</span><span class="o">).</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">partition6</span><span class="o">.</span><span class="na">upload</span><span class="o">()));</span>

<span class="c1">// wait for both of uploads to finish</span>
<span class="nc">Promises</span><span class="o">.</span><span class="na">all</span><span class="o">(</span><span class="n">uploadTo3</span><span class="o">,</span> <span class="n">uploadTo6</span><span class="o">)</span>
		<span class="c1">// and then download items from the cluster, and wait for result</span>
		<span class="o">.</span><span class="na">then</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">cluster</span><span class="o">.</span><span class="na">download</span><span class="o">())</span>
		<span class="c1">// also collecting it to list</span>
		<span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="nl">StreamSupplier:</span><span class="o">:</span><span class="n">toList</span><span class="o">)</span>
		<span class="c1">// and then print the resulting list of items, it should match the expectation from above</span>
		<span class="c1">// (remember that sets are unordered, so you may not see it exactly as above)</span>
		<span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">list</span><span class="o">,</span> <span class="err">$</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">));</span>

<span class="c1">// actually run the eventloop and then shutdown the executor allowing the program to finish</span>
<span class="n">eventloop</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span></code></pre></figure>

<h3 id="crdt-consolidation">CRDT consolidation</h3>
<p>This example illustrates consolidation process. ActiveJ CRDT file system creates a new file for each upload. This approach 
is faster and more efficient than writing everything in a single file. However when there are way too many files, this 
also becomes inefficient. In order to resolve this issue, ActiveJ CRDT has a special consolidation process which 
reorganizes several files in a single one:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// create our storage dir and an fs client which operates on that dir</span>
<span class="nc">Path</span> <span class="n">storage</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">createTempDirectory</span><span class="o">(</span><span class="s">"storage"</span><span class="o">);</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="nc">LocalActiveFs</span><span class="o">.</span><span class="na">DEFAULT_TEMP_DIR</span><span class="o">));</span>
<span class="nc">LocalActiveFs</span> <span class="n">fsClient</span> <span class="o">=</span> <span class="nc">LocalActiveFs</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">storage</span><span class="o">);</span>

<span class="c1">// our item is a set of integers, so we create a CRDT function for it</span>
<span class="c1">// also each CRDT item needs to have a timestamp, so we wrap the sets</span>
<span class="c1">// and the function using the TimestampContainer</span>
<span class="nc">CrdtFunction</span><span class="o">&lt;</span><span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="n">crdtFunction</span> <span class="o">=</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">createCrdtFunction</span><span class="o">(</span><span class="nl">CrdtFsConsolidationExample:</span><span class="o">:</span><span class="n">union</span><span class="o">);</span>

<span class="c1">// same with serializer for the timestamp container of the set of integers</span>
<span class="nc">CrdtDataSerializer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span> <span class="o">=</span>
		<span class="k">new</span> <span class="nc">CrdtDataSerializer</span><span class="o">&lt;&gt;(</span><span class="no">UTF8_SERIALIZER</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">createSerializer</span><span class="o">(</span><span class="n">ofSet</span><span class="o">(</span><span class="no">INT_SERIALIZER</span><span class="o">)));</span>

<span class="c1">// create an FS-based CRDT client</span>
<span class="nc">CrdtStorageFs</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">&lt;</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;&gt;</span> <span class="n">client</span> <span class="o">=</span>
		<span class="nc">CrdtStorageFs</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">eventloop</span><span class="o">,</span> <span class="n">fsClient</span><span class="o">,</span> <span class="n">serializer</span><span class="o">,</span> <span class="n">crdtFunction</span><span class="o">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// upload two streams of items to it in parallel</span>
<span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">firstUpload</span> <span class="o">=</span>
		<span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">ofStream</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"1_test_1"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"1_test_2"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">7</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"1_test_3"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">78</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"12_test_1"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">124</span><span class="o">,</span> <span class="mi">125</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"12_test_2"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">12</span><span class="o">)))).</span><span class="na">sorted</span><span class="o">())</span>
				<span class="o">.</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">upload</span><span class="o">()));</span>

<span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">secondUpload</span> <span class="o">=</span>
		<span class="nc">StreamSupplier</span><span class="o">.</span><span class="na">ofStream</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"2_test_1"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"2_test_2"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"2_test_3"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"12_test_1"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">542</span><span class="o">,</span> <span class="mi">125</span><span class="o">,</span> <span class="mi">2</span><span class="o">))),</span>
				<span class="k">new</span> <span class="nc">CrdtData</span><span class="o">&lt;&gt;(</span><span class="s">"12_test_2"</span><span class="o">,</span> <span class="nc">TimestampContainer</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mi">13</span><span class="o">)))).</span><span class="na">sorted</span><span class="o">())</span>
				<span class="o">.</span><span class="na">streamTo</span><span class="o">(</span><span class="nc">StreamConsumer</span><span class="o">.</span><span class="na">ofPromise</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">upload</span><span class="o">()));</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// and wait for both of uploads to finish</span>
<span class="nc">Promises</span><span class="o">.</span><span class="na">all</span><span class="o">(</span><span class="n">firstUpload</span><span class="o">,</span> <span class="n">secondUpload</span><span class="o">)</span>
		<span class="o">.</span><span class="na">whenComplete</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>

			<span class="c1">// all the operations are async, but we run them sequentially</span>
			<span class="c1">// because we need to see the file list exactly before and after</span>
			<span class="c1">// consolidation process</span>
			<span class="nc">Promises</span><span class="o">.</span><span class="na">sequence</span><span class="o">(</span>
					<span class="c1">// here we can see that two files were created, one for each upload</span>
					<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">fsClient</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="s">"**"</span><span class="o">)</span>
							<span class="o">.</span><span class="na">whenResult</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">))</span>
							<span class="o">.</span><span class="na">toVoid</span><span class="o">(),</span>

					<span class="c1">// run the consolidation process</span>
					<span class="nl">client:</span><span class="o">:</span><span class="n">consolidate</span><span class="o">,</span>

					<span class="c1">// now we can see that there is only one file left, and its size is</span>
					<span class="c1">// less than the sum of the sizes of the two files from above</span>
					<span class="o">()</span> <span class="o">-&gt;</span> <span class="n">fsClient</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="s">"**"</span><span class="o">)</span>
							<span class="o">.</span><span class="na">whenResult</span><span class="o">(</span><span class="n">res</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">))</span>
							<span class="o">.</span><span class="na">toVoid</span><span class="o">()</span>
			<span class="o">);</span>
		<span class="o">});</span>

<span class="c1">// all of the above will not run until we actually start the eventloop</span>
<span class="n">eventloop</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="c1">// shutdown the executor after the eventloop finishes (meaning there is no more work to do)</span>
<span class="c1">// because executor waits for 60 seconds of being idle until it shuts down on its own</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span></code></pre></figure>

    <div class="row docs-prevnext">
        
            <div class="col-sm-6"></div>
        
        
    </div>
</div>


                </div>
            </div>
        
        <div class="container justify-content-between footer">
            <div class="col-md-4 col-lg-5"> &copy; 2021 ActiveJ LLC. All Rights Reserved</div>
            <div class="col-md-4 col-lg-3">Contact us: contact@activej.io</div>
            <div class="col-md-8 col-lg-4 footer__menu">
                <a href="http://uikernel.io">UIKernel</a>
                <a href="https://adkernel.com">AdKernel</a>
                <a href="https://github.com/activej/activej">GitHub</a>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script src="../static/js/leon.js"></script>
    <script src="../static/js/index.js"></script>
    <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous">
    </script>
</body>
</html>
